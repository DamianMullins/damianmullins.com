---
import Layout from '@/layouts/Layout.astro'
import Strapline from '@/components/Strapline.astro'
import PostListing from '@/components/PostListing.astro'
import { AUTHOR_BIO } from '@/consts'
import { getCollection, render } from 'astro:content'

const posts = (await getCollection('posts', ({ data }) => data.published)).sort(
  (a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime()
)

const postsWithReadingTime = await Promise.all(
  posts.map(async post => {
    const { remarkPluginFrontmatter } = await render(post)
    return {
      ...post,
      minutesRead: remarkPluginFrontmatter?.minutesRead ?? 1
    }
  })
)
---

<Layout>
  <Fragment slot="head">
    <meta
      name="google-site-verification"
      content="a6Ox8VBA5N9ohpNFIepLCkROEGmvZc2eqnm6msYIMSk"
    />
  </Fragment>

  <Strapline text={AUTHOR_BIO} />

  {
    postsWithReadingTime.map(post => (
      <PostListing
        slug={post.data.slug}
        title={post.data.title}
        posted={post.data.date}
        minutesRead={post.minutesRead}
        description={post.data.description}
      />
    ))
  }
</Layout>
