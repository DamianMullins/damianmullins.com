---
import Layout from '@/layouts/Layout.astro'
import Tags from '@/components/Tags.astro'
import PostTime from '@/components/PostTime.astro'
import { AUTHOR_BIO } from '@/consts'
import { getCollection, render } from 'astro:content'
import type { GetStaticPaths } from 'astro'
import type { CollectionEntry } from 'astro:content'

export const getStaticPaths: GetStaticPaths = async () => {
  const posts = await getCollection('posts', ({ data }) => data.published)

  return posts.map(post => {
    // Strip leading/trailing slashes from the frontmatter slug for the URL param
    const slug = post.data.slug.replace(/^\/|\/$/g, '')
    return {
      params: { slug },
      props: { post }
    }
  })
}

const { post } = Astro.props as { post: CollectionEntry<'posts'> }
const { Content, remarkPluginFrontmatter } = await render(post)
const { title, date, description, tags } = post.data
const minutesRead = remarkPluginFrontmatter?.minutesRead ?? 1
---

<Layout title={title} description={description || AUTHOR_BIO}>
  <h1>{title}</h1>

  <PostTime posted={date} minutesRead={minutesRead} />

  <div class="ornament" aria-hidden="true">&bull; &bull; &bull;</div>

  <div
    class="post-content prose prose-headings:font-[var(--font-heading)] prose-headings:font-bold prose-a:text-[var(--color-accent)] prose-blockquote:not-italic max-w-none text-[1.1rem]">
    <Content />
  </div>

  <Tags tags={tags} />
</Layout>

<script>
  function initImageReveal() {
    const images = document.querySelectorAll('.post-content img')
    if (!images.length) return

    const observer = new IntersectionObserver(
      entries => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            entry.target.classList.add('visible')
            observer.unobserve(entry.target)
          }
        })
      },
      { threshold: 0.1, rootMargin: '0px 0px -40px 0px' }
    )

    images.forEach(img => observer.observe(img))
  }

  initImageReveal()
  document.addEventListener('astro:after-swap', initImageReveal)
</script>
